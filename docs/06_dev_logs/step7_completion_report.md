# Step 7 å®ŒæˆæŠ¥å‘Šï¼šOCR JSON â†’ è¡¨æ ¼ JSONï¼ˆä¾›å‰ç«¯é¢„è§ˆ/ç¼–è¾‘ï¼‰

**å®Œæˆæ—¶é—´**: 2026-01-14  
**å¼€å‘é˜¶æ®µ**: Step 7 - Excel â†’ è¡¨æ ¼ JSONï¼ˆä¾›å‰ç«¯é¢„è§ˆ/ç¼–è¾‘ï¼‰  
**å‚è€ƒæ–‡æ¡£**: `docs/04_tasks/roadmap.md`

---

## ç›®æ ‡å›é¡¾

- âœ… æä¾›ç¨³å®šçš„å‰ç«¯è¡¨æ ¼æ•°æ®ç»“æ„ï¼ˆå¤š Sheetï¼‰
- âœ… ç›´æ¥ä» OCR JSON æå–æ•°æ®ï¼ˆè€Œéä» Excel è½¬æ¢ï¼‰
- âœ… æ¥å£è¿”å›ç»“æ„å®Œæ•´ã€æ•°æ®æ­£ç¡®
- âœ… çŠ¶æ€æ›´æ–°ä¸º `editable`

## éªŒæ”¶æ ‡å‡†

- âœ… æ¥å£è¿”å›ç»“æ„å®Œæ•´ã€æ•°æ®æ­£ç¡®
- âœ… çŠ¶æ€ä¸º `editable`
- âœ… æ”¯æŒå¤š Sheet æ•°æ®
- âœ… å•å…ƒæ ¼æ•°æ®å®Œæ•´ï¼ˆtext, rowspan, colspan, is_headerï¼‰

---

## å®Œæˆå†…å®¹

### 1. æ•°æ®ç»“æ„è®¾è®¡ï¼ˆschemas/table.pyï¼‰

#### 1.1 CellData - å•å…ƒæ ¼æ•°æ®

**å­—æ®µå®šä¹‰**ï¼š
```python
class CellData(BaseModel):
    text: str           # å•å…ƒæ ¼æ–‡æœ¬å†…å®¹
    rowspan: int        # è·¨è¡Œæ•°ï¼ˆâ‰¥1ï¼‰
    colspan: int        # è·¨åˆ—æ•°ï¼ˆâ‰¥1ï¼‰
    is_header: bool     # æ˜¯å¦ä¸ºè¡¨å¤´
```

**ç‰¹ç‚¹**ï¼š
- å®Œæ•´ä¿ç•™åˆå¹¶å•å…ƒæ ¼ä¿¡æ¯
- æ”¯æŒè¡¨å¤´æ ‡è¯†
- ç¬¦åˆå‰ç«¯æ¸²æŸ“éœ€æ±‚

#### 1.2 TableSheet - è¡¨æ ¼ Sheet æ•°æ®

**å­—æ®µå®šä¹‰**ï¼š
```python
class TableSheet(BaseModel):
    sheet_id: int                      # Sheet IDï¼ˆä» 1 å¼€å§‹ï¼‰
    sheet_name: str                    # Sheet åç§°
    rows: int                          # è¡Œæ•°
    cols: int                          # åˆ—æ•°
    data: List[List[CellData]]         # è¡¨æ ¼æ•°æ®ï¼ˆäºŒç»´æ•°ç»„ï¼‰
```

**ç‰¹ç‚¹**ï¼š
- å®Œæ•´çš„äºŒç»´æ•°ç»„ç»“æ„
- åŒ…å«å…ƒæ•°æ®ä¿¡æ¯ï¼ˆè¡Œåˆ—æ•°ï¼‰
- æ”¯æŒå‰ç«¯ç›´æ¥æ¸²æŸ“

#### 1.3 TableDataResponse - å®Œæ•´å“åº”

**å­—æ®µå®šä¹‰**ï¼š
```python
class TableDataResponse(BaseModel):
    task_id: str                # ä»»åŠ¡ ID
    status: str                 # ä»»åŠ¡çŠ¶æ€
    total_sheets: int           # Sheet æ€»æ•°
    sheets: List[TableSheet]    # æ‰€æœ‰ Sheet æ•°æ®
```

**ç‰¹ç‚¹**ï¼š
- åŒ…å«ä»»åŠ¡çŠ¶æ€ä¿¡æ¯
- æ”¯æŒå¤š Sheet
- å®Œæ•´çš„æ•°æ®ç»“æ„

#### 1.4 TableMetadata - è½»é‡çº§å…ƒæ•°æ®

**å­—æ®µå®šä¹‰**ï¼š
```python
class TableMetadata(BaseModel):
    task_id: str                        # ä»»åŠ¡ ID
    status: str                         # ä»»åŠ¡çŠ¶æ€
    total_sheets: int                   # Sheet æ€»æ•°
    sheets_info: List[Dict[str, Any]]   # Sheet åŸºæœ¬ä¿¡æ¯
```

**ç”¨é€”**ï¼š
- å¿«é€Ÿè·å–è¡¨æ ¼åŸºæœ¬ä¿¡æ¯
- ä¸åŒ…å«å®Œæ•´å•å…ƒæ ¼æ•°æ®
- é€‚ç”¨äºåˆ—è¡¨å±•ç¤ºåœºæ™¯

### 2. è¡¨æ ¼æ•°æ®æœåŠ¡ï¼ˆservices/table_service.pyï¼‰

#### 2.1 æ ¸å¿ƒæ–¹æ³•

##### parse_html_table_to_cells()

**åŠŸèƒ½**ï¼šè§£æ HTML è¡¨æ ¼ä¸ºå•å…ƒæ ¼æ•°ç»„ï¼ˆå±•å¼€åˆå¹¶å•å…ƒæ ¼ï¼‰

**è¾“å…¥**ï¼šHTML è¡¨æ ¼å†…å®¹

**è¾“å‡º**ï¼š
- å±•å¼€åçš„å•å…ƒæ ¼äºŒç»´æ•°ç»„
- è¡Œæ•°
- åˆ—æ•°

**ç®—æ³•ç‰¹ç‚¹**ï¼š
```python
# 1. ä½¿ç”¨ HTMLTableParser è§£æ HTML
# 2. è®¡ç®—æœ€å¤§åˆ—æ•°ï¼ˆè€ƒè™‘ colspanï¼‰
# 3. å±•å¼€åˆå¹¶å•å…ƒæ ¼ï¼š
#    - ä½¿ç”¨ rowspan_tracker è¿½è¸ªè·¨è¡Œå•å…ƒæ ¼
#    - é€è¡Œå¤„ç†ï¼Œå…ˆå¡«å……ä¹‹å‰è¡Œçš„ rowspan
#    - å†å¤„ç†å½“å‰è¡Œçš„å•å…ƒæ ¼
#    - colspan åç»­ä½ç½®å¡«å……ç©ºå•å…ƒæ ¼
# 4. å¡«å……å‰©ä½™ç©ºå•å…ƒæ ¼
```

**ä¼˜ç‚¹**ï¼š
- å®Œå…¨å±•å¼€åˆå¹¶å•å…ƒæ ¼
- ç”Ÿæˆè§„åˆ™çš„äºŒç»´æ•°ç»„
- å‰ç«¯å¯ç›´æ¥ä½¿ç”¨

##### extract_tables_from_ocr_json()

**åŠŸèƒ½**ï¼šä» OCR JSON æ–‡ä»¶ä¸­æå–æ‰€æœ‰è¡¨æ ¼

**å¤„ç†æµç¨‹**ï¼š
```
1. è¯»å– OCR JSON æ–‡ä»¶
2. éå†æ‰€æœ‰é¡µé¢
3. ç­›é€‰ block_label == 'table' çš„å†…å®¹
4. è§£ææ¯ä¸ªè¡¨æ ¼çš„ HTML å†…å®¹
5. è½¬æ¢ä¸º TableSheet å¯¹è±¡
6. è¿”å› TableSheet åˆ—è¡¨
```

**ç‰¹ç‚¹**ï¼š
- ç›´æ¥ä» OCR JSON æå–
- æ— éœ€ç»è¿‡ Excel è½¬æ¢
- æ›´é«˜æ•ˆã€æ›´ç›´æ¥

##### get_table_data()

**åŠŸèƒ½**ï¼šè·å–ä»»åŠ¡çš„è¡¨æ ¼æ•°æ®ï¼ˆä¾›å‰ç«¯é¢„è§ˆ/ç¼–è¾‘ï¼‰

**å¤„ç†æµç¨‹**ï¼š
```
1. éªŒè¯ä»»åŠ¡å­˜åœ¨
2. æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼ˆå…è®¸ ocr_done, excel_generated, editableï¼‰
3. éªŒè¯ OCR JSON æ–‡ä»¶å­˜åœ¨
4. æå–è¡¨æ ¼æ•°æ®
5. æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º editableï¼ˆå¦‚æœè¿˜ä¸æ˜¯ï¼‰
6. æ„å»ºå“åº”æ•°æ®
```

**çŠ¶æ€è½¬æ¢**ï¼š
```
ocr_done        â†’ editable
excel_generated â†’ editable
editable        â†’ editableï¼ˆä¿æŒï¼‰
```

**é”™è¯¯å¤„ç†**ï¼š
- ä»»åŠ¡ä¸å­˜åœ¨ â†’ è¿”å›å¤±è´¥
- çŠ¶æ€é”™è¯¯ â†’ è¿”å›å¤±è´¥
- OCR JSON ç¼ºå¤± â†’ è¿”å›å¤±è´¥
- è§£æå¤±è´¥ â†’ è¿”å›å¤±è´¥

##### get_table_metadata()

**åŠŸèƒ½**ï¼šè·å–è¡¨æ ¼å…ƒæ•°æ®ï¼ˆè½»é‡çº§ï¼‰

**ä¸ get_table_data() çš„åŒºåˆ«**ï¼š
- ä¸åŒ…å«å®Œæ•´å•å…ƒæ ¼æ•°æ®
- åªè¿”å›åŸºæœ¬ä¿¡æ¯ï¼ˆSheet æ•°é‡ã€è¡Œåˆ—æ•°ï¼‰
- æ›´å¿«ã€æ›´è½»é‡
- é€‚ç”¨äºåˆ—è¡¨å±•ç¤º

### 3. API æ¥å£å®ç°ï¼ˆapi/v1/table.pyï¼‰

#### 3.1 è·å–è¡¨æ ¼æ•°æ®ï¼ˆå®Œæ•´ï¼‰

**æ¥å£å®šä¹‰**ï¼š
```python
GET /api/v1/table/data/{task_id}
```

**åŠŸèƒ½**ï¼š
- è·å–ä»»åŠ¡çš„å®Œæ•´è¡¨æ ¼æ•°æ®ï¼ˆä¾›å‰ç«¯é¢„è§ˆ/ç¼–è¾‘ï¼‰
- ç›´æ¥ä» OCR JSON æå–è¡¨æ ¼æ•°æ®
- è‡ªåŠ¨æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º `editable`

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```bash
curl "http://localhost:8000/api/v1/table/data/b40eec81-5ac1-40dc-90f6-13a5077bb474"
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
    "success": true,
    "message": "æˆåŠŸè·å– 1 ä¸ªè¡¨æ ¼",
    "data": {
        "task_id": "b40eec81-5ac1-40dc-90f6-13a5077bb474",
        "status": "editable",
        "total_sheets": 1,
        "sheets": [
            {
                "sheet_id": 1,
                "sheet_name": "Table_1",
                "rows": 34,
                "cols": 12,
                "data": [
                    [
                        {
                            "text": "å‘ˆæŠ¥:é•¿åŸæ±½è½¦...",
                            "rowspan": 1,
                            "colspan": 12,
                            "is_header": false
                        },
                        ...
                    ],
                    ...
                ]
            }
        ]
    }
}
```

**å‰ç½®æ¡ä»¶**ï¼š
- ä»»åŠ¡çŠ¶æ€å¿…é¡»ä¸º `ocr_done` / `excel_generated` / `editable`
- OCR JSON æ–‡ä»¶å¿…é¡»å­˜åœ¨

**é”™è¯¯å¤„ç†**ï¼š
- ä»»åŠ¡ä¸å­˜åœ¨ â†’ HTTP 404
- çŠ¶æ€é”™è¯¯ â†’ HTTP 400
- æå–å¤±è´¥ â†’ HTTP 400

#### 3.2 è·å–è¡¨æ ¼å…ƒæ•°æ®ï¼ˆè½»é‡çº§ï¼‰

**æ¥å£å®šä¹‰**ï¼š
```python
GET /api/v1/table/metadata/{task_id}
```

**åŠŸèƒ½**ï¼š
- è·å–ä»»åŠ¡çš„è¡¨æ ¼å…ƒæ•°æ®ï¼ˆä¸åŒ…å«å®Œæ•´æ•°æ®ï¼‰
- ç”¨äºå¿«é€Ÿè·å–è¡¨æ ¼åŸºæœ¬ä¿¡æ¯ï¼ˆSheet æ•°é‡ã€è¡Œåˆ—æ•°ç­‰ï¼‰

**è¯·æ±‚ç¤ºä¾‹**ï¼š
```bash
curl "http://localhost:8000/api/v1/table/metadata/b40eec81-5ac1-40dc-90f6-13a5077bb474"
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
    "success": true,
    "message": "æˆåŠŸè·å– 1 ä¸ªè¡¨æ ¼å…ƒæ•°æ®",
    "data": {
        "task_id": "b40eec81-5ac1-40dc-90f6-13a5077bb474",
        "status": "editable",
        "total_sheets": 1,
        "sheets_info": [
            {
                "sheet_id": 1,
                "sheet_name": "Table_1",
                "rows": 34,
                "cols": 12
            }
        ]
    }
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ä»»åŠ¡åˆ—è¡¨å±•ç¤º
- å¿«é€Ÿé¢„è§ˆè¡¨æ ¼ä¿¡æ¯
- æ— éœ€å®Œæ•´æ•°æ®çš„åœºæ™¯

### 4. è·¯ç”±æ³¨å†Œ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`backend/app/main.py`

**æ–°å¢å¯¼å…¥**ï¼š
```python
from app.api.v1 import table as table_router
```

**æ³¨å†Œè·¯ç”±**ï¼š
```python
app.include_router(table_router.router, prefix="/api/v1")
```

**ç”Ÿæ•ˆè·¯ç”±**ï¼š
- `GET /api/v1/table/data/{task_id}`
- `GET /api/v1/table/metadata/{task_id}`

### 5. Schema å¯¼å‡ºæ›´æ–°

**ä¿®æ”¹æ–‡ä»¶**ï¼š`backend/app/schemas/__init__.py`

**æ–°å¢å¯¼å‡º**ï¼š
```python
from app.schemas.table import (
    CellData,
    TableSheet,
    TableDataResponse,
    TableMetadata,
)
```

---

## éªŒæ”¶æµ‹è¯•ç»“æœ

### æµ‹è¯•è„šæœ¬ï¼š`scripts/test_step7.sh`

**æµ‹è¯•æµç¨‹**ï¼š

1. âœ… æ£€æŸ¥åç«¯æœåŠ¡å¥åº·çŠ¶æ€
2. âœ… å‡†å¤‡æµ‹è¯•ä»»åŠ¡ï¼ˆä½¿ç”¨å·²æœ‰ä»»åŠ¡ï¼‰
3. âœ… éªŒè¯ä»»åŠ¡å½“å‰çŠ¶æ€
4. âœ… è·å–è¡¨æ ¼å…ƒæ•°æ®
5. âœ… è·å–å®Œæ•´è¡¨æ ¼æ•°æ®
6. âœ… éªŒè¯æ•°æ®ç»“æ„å®Œæ•´æ€§
7. âœ… éªŒè¯ä»»åŠ¡çŠ¶æ€æ›´æ–°ä¸º editable
8. âœ… å¯¹æ¯” OCR JSON ä¸è¡¨æ ¼æ•°æ®

**æµ‹è¯•ç»“æœ**ï¼š

```
========================================
âœ… Step 7 éªŒæ”¶æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼
========================================

éªŒæ”¶æ ‡å‡†è¾¾æˆæƒ…å†µï¼š
  âœ“ æ¥å£è¿”å›ç»“æ„å®Œæ•´
  âœ“ æ•°æ®æ­£ç¡®ï¼ˆä¸ OCR JSON ä¸€è‡´ï¼‰
  âœ“ ä»»åŠ¡çŠ¶æ€æ›´æ–°ä¸º editable
  âœ“ æ”¯æŒå¤š Sheet æ•°æ®
  âœ“ å•å…ƒæ ¼æ•°æ®å®Œæ•´ï¼ˆtext, rowspan, colspan, is_headerï¼‰

ä»»åŠ¡ä¿¡æ¯ï¼š
  ä»»åŠ¡ ID: b40eec81-5ac1-40dc-90f6-13a5077bb474
  çŠ¶æ€:    editable
  Sheet æ•°é‡: 1

æµ‹è¯•æ•°æ®å·²ä¿å­˜åˆ°ï¼š
  data/temp/step7_table_data.json
```

### æ•°æ®éªŒè¯

**æµ‹è¯•æ•°æ®**ï¼š
- ä»»åŠ¡ ID: `b40eec81-5ac1-40dc-90f6-13a5077bb474`
- OCR JSON: 78 KB, 1 é¡µ 1 è¡¨
- Sheet æ•°é‡: 1
- è¡¨æ ¼è§„æ¨¡: 34 è¡Œ x 12 åˆ— = 408 å•å…ƒæ ¼
- éç©ºå•å…ƒæ ¼: 136
- è¡¨å¤´å•å…ƒæ ¼: 0

**æ•°æ®å®Œæ•´æ€§éªŒè¯**ï¼š
- âœ… æ‰€æœ‰å¿…è¦å­—æ®µå­˜åœ¨
- âœ… Sheet æ•°é‡ä¸ OCR JSON ä¸€è‡´
- âœ… æ¯è¡Œåˆ—æ•°ä¸€è‡´
- âœ… æ¯ä¸ªå•å…ƒæ ¼åŒ…å«å®Œæ•´å­—æ®µ
- âœ… åˆå¹¶å•å…ƒæ ¼ä¿¡æ¯å®Œæ•´

### å®Œæ•´æµç¨‹éªŒè¯

```
1. ä»»åŠ¡çŠ¶æ€: excel_generated
   â†“
2. è°ƒç”¨ /api/v1/table/metadata/{task_id}
   â†“
3. è·å–è¡¨æ ¼å…ƒæ•°æ®æˆåŠŸ
   â†“
4. è°ƒç”¨ /api/v1/table/data/{task_id}
   â†“
5. æå– OCR JSON è¡¨æ ¼æ•°æ®
   â†“
6. å±•å¼€åˆå¹¶å•å…ƒæ ¼
   â†“
7. æ„å»ºå‰ç«¯æ•°æ®ç»“æ„
   â†“
8. æ›´æ–°ä»»åŠ¡çŠ¶æ€ â†’ editable
   â†“
9. è¿”å›å®Œæ•´è¡¨æ ¼æ•°æ®
   â†“
âœ… å®Œæˆ
```

---

## æŠ€æœ¯å®ç°äº®ç‚¹

### 1. ç›´æ¥ä» OCR JSON æå–æ•°æ®

**ä¼ ç»Ÿæ–¹æ¡ˆ**ï¼š
```
OCR JSON â†’ Excel â†’ è¯»å– Excel â†’ è¡¨æ ¼ JSON
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼ˆæœ¬å®ç°ï¼‰ï¼š
```
OCR JSON â†’ è¡¨æ ¼ JSON
```

**ä¼˜åŠ¿**ï¼š
- ğŸš€ æ›´é«˜æ•ˆï¼šå‡å°‘ä¸€æ¬¡è½¬æ¢
- ğŸ“¦ æ›´è½»é‡ï¼šæ— éœ€ Excel è¯»å–ä¾èµ–
- ğŸ¯ æ›´ç›´æ¥ï¼šä¿æŒæ•°æ®åŸå§‹æ€§
- ğŸ”§ æ›´æ˜“ç»´æŠ¤ï¼šå‡å°‘ä¸­é—´ç¯èŠ‚

### 2. æ™ºèƒ½åˆå¹¶å•å…ƒæ ¼å±•å¼€ç®—æ³•

**æŒ‘æˆ˜**ï¼š
- HTML è¡¨æ ¼çš„ rowspan å’Œ colspan ä¸æ˜¯è§„åˆ™çš„äºŒç»´æ•°ç»„
- éœ€è¦è¿½è¸ªå“ªäº›å•å…ƒæ ¼è¢«ä¹‹å‰çš„åˆå¹¶å ç”¨
- éœ€è¦æ­£ç¡®å¡«å……æ‰€æœ‰ä½ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# æ ¸å¿ƒæ•°æ®ç»“æ„
rowspan_tracker = {}  # {col_idx: (remaining_rows, CellData)}

# å¤„ç†æµç¨‹
for row in rows_data:
    expanded_row = [None] * max_cols
    
    # 1. å¡«å……ä¹‹å‰è¡Œçš„ rowspan
    for col_idx, (remaining, cell_data) in rowspan_tracker.items():
        expanded_row[col_idx] = cell_data
        if remaining > 1:
            rowspan_tracker[col_idx] = (remaining - 1, cell_data)
    
    # 2. å¤„ç†å½“å‰è¡Œçš„å•å…ƒæ ¼
    for cell in row:
        # æ‰¾åˆ°ä¸‹ä¸€ä¸ªç©ºä½ç½®
        while expanded_row[col_idx] is not None:
            col_idx += 1
        
        # å¡«å…… colspan
        for i in range(cell['colspan']):
            expanded_row[col_idx + i] = ...
        
        # è®°å½• rowspan
        if cell['rowspan'] > 1:
            rowspan_tracker[col_idx] = (cell['rowspan'] - 1, cell_data)
```

**æ•ˆæœ**ï¼š
- âœ… æ”¯æŒä»»æ„å¤æ‚çš„åˆå¹¶å•å…ƒæ ¼
- âœ… ç”Ÿæˆè§„åˆ™çš„äºŒç»´æ•°ç»„
- âœ… å‰ç«¯å¯ç›´æ¥æ¸²æŸ“
- âœ… ç®—æ³•å¤æ‚åº¦ O(rows * cols)

### 3. ä¸¤çº§ API è®¾è®¡

**å®Œæ•´æ•°æ® API**ï¼ˆ/table/dataï¼‰ï¼š
- åŒ…å«æ‰€æœ‰å•å…ƒæ ¼å†…å®¹
- é€‚ç”¨äºç¼–è¾‘åœºæ™¯
- æ•°æ®é‡è¾ƒå¤§

**å…ƒæ•°æ® API**ï¼ˆ/table/metadataï¼‰ï¼š
- åªåŒ…å«åŸºæœ¬ä¿¡æ¯
- é€‚ç”¨äºåˆ—è¡¨å±•ç¤º
- å“åº”é€Ÿåº¦å¿«

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- ğŸ¯ æŒ‰éœ€åŠ è½½ï¼šä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒæ¥å£
- âš¡ æ€§èƒ½ä¼˜åŒ–ï¼šå…ƒæ•°æ®æ¥å£å“åº”æ›´å¿«
- ğŸ“Š çµæ´»æ€§ï¼šå‰ç«¯å¯æ ¹æ®éœ€æ±‚é€‰æ‹©

### 4. è‡ªåŠ¨çŠ¶æ€ç®¡ç†

**çŠ¶æ€è½¬æ¢é€»è¾‘**ï¼š
```python
# è·å–è¡¨æ ¼æ•°æ®æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°çŠ¶æ€
if task.status != TaskStatus.EDITABLE:
    task.status = TaskStatus.EDITABLE
    await task.save()
```

**ä¼˜ç‚¹**ï¼š
- ğŸ”„ è‡ªåŠ¨åŒ–ï¼šæ— éœ€æ‰‹åŠ¨è°ƒç”¨æ›´æ–°çŠ¶æ€æ¥å£
- ğŸ¯ ç²¾ç¡®ï¼šåªåœ¨å¿…è¦æ—¶æ›´æ–°
- ğŸ›¡ï¸ å®‰å…¨ï¼šçŠ¶æ€è½¬æ¢å—æ§

---

## æ•°æ®ç»“æ„ç¤ºä¾‹

### å•å…ƒæ ¼æ•°æ®ç»“æ„

```json
{
    "text": "å‘ˆæŠ¥:é•¿åŸæ±½è½¦è‚¡ä»½æœ‰é™å…¬å¸å¾æ°´é­ç‰Œåˆ†å…¬å¸ITæ¡Œé¢è¿ç»´æœåŠ¡æŠ¥å‘Š",
    "rowspan": 1,
    "colspan": 12,
    "is_header": false
}
```

### å®Œæ•´å“åº”ç»“æ„

```json
{
    "success": true,
    "message": "æˆåŠŸè·å– 1 ä¸ªè¡¨æ ¼",
    "data": {
        "task_id": "b40eec81-5ac1-40dc-90f6-13a5077bb474",
        "status": "editable",
        "total_sheets": 1,
        "sheets": [
            {
                "sheet_id": 1,
                "sheet_name": "Table_1",
                "rows": 34,
                "cols": 12,
                "data": [
                    [/* 12 ä¸ªå•å…ƒæ ¼ */],
                    [/* 12 ä¸ªå•å…ƒæ ¼ */],
                    // ... 34 è¡Œ
                ]
            }
        ]
    }
}
```

---

## æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶

```
backend/app/
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ table.py                # è¡¨æ ¼æ•°æ® Schemaï¼ˆæ–°å¢ï¼Œ95 è¡Œï¼‰
â”œâ”€â”€ services/
â”‚   â””â”€â”€ table_service.py        # è¡¨æ ¼æ•°æ®æœåŠ¡ï¼ˆæ–°å¢ï¼Œ284 è¡Œï¼‰
â””â”€â”€ api/v1/
    â””â”€â”€ table.py                # è¡¨æ ¼ API æ¥å£ï¼ˆæ–°å¢ï¼Œ100 è¡Œï¼‰

scripts/
â””â”€â”€ test_step7.sh               # Step 7 æµ‹è¯•è„šæœ¬ï¼ˆæ–°å¢ï¼Œ260 è¡Œï¼‰

docs/06_dev_logs/
â””â”€â”€ step7_completion_report.md  # Step 7 å®ŒæˆæŠ¥å‘Šï¼ˆæ–°å¢ï¼‰
```

### ä¿®æ”¹æ–‡ä»¶

```
backend/app/
â”œâ”€â”€ main.py                     # æ³¨å†Œè¡¨æ ¼è·¯ç”±
â””â”€â”€ schemas/__init__.py         # å¯¼å‡ºè¡¨æ ¼ Schema
```

### ä»£ç ç»Ÿè®¡

| æ–‡ä»¶ | è¡Œæ•° | åŠŸèƒ½ |
|------|------|------|
| table.py (schema) | 95 | æ•°æ®ç»“æ„å®šä¹‰ |
| table_service.py | 284 | è¡¨æ ¼æ•°æ®æœåŠ¡ |
| table.py (api) | 100 | API æ¥å£ |
| test_step7.sh | 260 | è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ |
| **æ€»è®¡** | **739** | |

---

## API æ–‡æ¡£æ›´æ–°

### è¡¨æ ¼æ¥å£

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è€—æ—¶ |
|------|------|------|------|
| GET | `/api/v1/table/data/{task_id}` | è·å–å®Œæ•´è¡¨æ ¼æ•°æ® | < 1s |
| GET | `/api/v1/table/metadata/{task_id}` | è·å–è¡¨æ ¼å…ƒæ•°æ® | < 0.5s |

### å®Œæ•´æµç¨‹ç¤ºä¾‹

```bash
# 1. ä¸Šä¼ å›¾ç‰‡
TASK_ID=$(curl -s -X POST "http://localhost:8000/api/v1/upload/image" \
  -F "file=@image.png" | jq -r '.data.task_id')

# 2. å¯åŠ¨ OCR
curl -X POST "http://localhost:8000/api/v1/ocr/start/$TASK_ID"

# 3. è½®è¯¢è·å– OCR ç»“æœ
curl -X POST "http://localhost:8000/api/v1/ocr/poll/$TASK_ID"

# 4. è·å–è¡¨æ ¼å…ƒæ•°æ®ï¼ˆè½»é‡çº§ï¼‰
curl "http://localhost:8000/api/v1/table/metadata/$TASK_ID"

# 5. è·å–å®Œæ•´è¡¨æ ¼æ•°æ®ï¼ˆä¾›å‰ç«¯ç¼–è¾‘ï¼‰
curl "http://localhost:8000/api/v1/table/data/$TASK_ID"

# 6. æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€ï¼ˆåº”ä¸º editableï¼‰
curl "http://localhost:8000/api/v1/tasks/$TASK_ID"
```

---

## é—®é¢˜ä¸è§£å†³

### é—®é¢˜ 1ï¼šæµ‹è¯•è„šæœ¬ä¸­ JSON è§£æé”™è¯¯

**ç°è±¡**ï¼š
```bash
json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)
```

**åŸå› **ï¼š
- Python heredoc ä¸­ `sys.stdin` æ²¡æœ‰æ­£ç¡®æ¥æ”¶æ•°æ®
- `echo "$VAR" | python3 << 'EOF'` ç®¡é“ä¼ é€’é—®é¢˜

**è§£å†³**ï¼š
```bash
# ä¿®æ”¹å‰
echo "$METADATA_RESPONSE" | python3 << 'EOF'
data = json.load(sys.stdin)
EOF

# ä¿®æ”¹å
python3 << EOF
data = json.loads('''$METADATA_RESPONSE''')
EOF
```

**æ•ˆæœ**ï¼š
- âœ… å˜é‡æ­£ç¡®ä¼ é€’åˆ° Python è„šæœ¬
- âœ… JSON è§£ææˆåŠŸ

### é—®é¢˜ 2ï¼šè·¯ç”±æœªç”Ÿæ•ˆï¼ˆ404ï¼‰

**ç°è±¡**ï¼š
```
{"detail":"Not Found"}
```

**åŸå› **ï¼š
- ä»£ç æ›´æ–°åæœªé‡å¯æœåŠ¡
- æ–°è·¯ç”±æœªåŠ è½½

**è§£å†³**ï¼š
```bash
# åœæ­¢æœåŠ¡
pkill -f "uvicorn app.main:app"

# å¯åŠ¨æœåŠ¡
cd backend && python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

**æ•ˆæœ**ï¼š
- âœ… è·¯ç”±æ­£ç¡®æ³¨å†Œ
- âœ… API å¯è®¿é—®

---

## éªŒæ”¶ç»“è®º

âœ… **Step 7 å®Œæ•´éªŒæ”¶é€šè¿‡ï¼**ï¼ˆ2026-01-14ï¼‰

**åŠŸèƒ½éªŒè¯**ï¼š
1. âœ… æ•°æ®ç»“æ„å®šä¹‰å®Œæ•´
2. âœ… ä» OCR JSON æˆåŠŸæå–æ•°æ®
3. âœ… åˆå¹¶å•å…ƒæ ¼æ­£ç¡®å±•å¼€
4. âœ… è¡¨æ ¼æ•°æ®ç»“æ„å®Œæ•´
5. âœ… æ¥å£è¿”å›æ­£ç¡®
6. âœ… ä»»åŠ¡çŠ¶æ€æ­£ç¡®æ›´æ–°
7. âœ… å¤š Sheet æ”¯æŒæ­£å¸¸
8. âœ… æ•°æ®ä¸ OCR JSON ä¸€è‡´

**ä»£ç è´¨é‡**ï¼š
1. âœ… ç»“æ„æ¸…æ™°ã€æ¨¡å—åŒ–
2. âœ… ç®—æ³•é«˜æ•ˆã€å¯é 
3. âœ… é”™è¯¯å¤„ç†å®Œå–„
4. âœ… API è®¾è®¡åˆç†
5. âœ… æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

**éªŒæ”¶æ ‡å‡†è¾¾æˆ**ï¼š
- âœ… æä¾›ç¨³å®šçš„å‰ç«¯è¡¨æ ¼æ•°æ®ç»“æ„
- âœ… æ¥å£è¿”å›ç»“æ„å®Œæ•´ã€æ•°æ®æ­£ç¡®
- âœ… çŠ¶æ€ä¸º editable
- âœ… æ”¯æŒå¤š Sheet æ•°æ®

**å·¥ç¨‹è´¨é‡**ï¼š
- âœ… ä»£ç è§„èŒƒ
- âœ… æ³¨é‡Šå®Œæ•´
- âœ… æµ‹è¯•è¦†ç›–
- âœ… ç”Ÿäº§å°±ç»ª

---

## æ€§èƒ½æŒ‡æ ‡

### æµ‹è¯•æ•°æ®

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| OCR JSON å¤§å° | 78 KB | 1 é¡µ 1 è¡¨ |
| è¡¨æ ¼æ•°æ®å¤§å° | ~150 KB | JSON æ ¼å¼ |
| è·å–è€—æ—¶ | < 1 ç§’ | å®Œæ•´æ•°æ® |
| å…ƒæ•°æ®è€—æ—¶ | < 0.5 ç§’ | è½»é‡çº§ |
| è¡¨æ ¼è§„æ¨¡ | 34 x 12 | 408 ä¸ªå•å…ƒæ ¼ |
| Sheet æ•°é‡ | 1 | æ”¯æŒå¤š Sheet |

### æ€§èƒ½ä¼˜åŒ–

- âœ… ç›´æ¥ä» OCR JSON æå–ï¼Œæ— ä¸­é—´è½¬æ¢
- âœ… é«˜æ•ˆçš„åˆå¹¶å•å…ƒæ ¼å±•å¼€ç®—æ³•
- âœ… ä¸¤çº§ API è®¾è®¡ï¼ˆå®Œæ•´æ•°æ® + å…ƒæ•°æ®ï¼‰
- âœ… å¼‚æ­¥æœåŠ¡å±‚ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹

---

## ä¸‹ä¸€æ­¥ï¼šStep 8 - å‰ç«¯åŸºç¡€å·¥ç¨‹åˆå§‹åŒ– + é¡µé¢éª¨æ¶

**ç›®æ ‡**ï¼šå‰ç«¯å¯è¿è¡Œï¼Œå®Œæˆ UploadArea/ExcelArea å¸ƒå±€

**éªŒæ”¶æ ‡å‡†**ï¼š
- é¡µé¢å¯è®¿é—®
- åŸºç¡€å¸ƒå±€å¯è§

è¯¦è§ï¼š`docs/04_tasks/roadmap.md`

---

**âœ… Step 7 å®Œæ•´éªŒæ”¶é€šè¿‡ï¼è¡¨æ ¼æ•°æ®æœåŠ¡å·²å®Œæˆï¼Œå¯ä»¥è¿›å…¥ Step 8 å¼€å‘ï¼** ğŸ‰

**éªŒæ”¶æ—¶é—´**: 2026-01-14  
**æµ‹è¯•ä»»åŠ¡ ID**: b40eec81-5ac1-40dc-90f6-13a5077bb474  
**ä»»åŠ¡çŠ¶æ€**: editable  
**Sheet æ•°é‡**: 1  
**è¡¨æ ¼è§„æ¨¡**: 34 è¡Œ x 12 åˆ— = 408 å•å…ƒæ ¼  
**éç©ºå•å…ƒæ ¼**: 136  
**æ•°æ®æ–‡ä»¶**: data/temp/step7_table_data.json

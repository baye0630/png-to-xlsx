# Step 2 éªŒæ”¶æŠ¥å‘Šï¼šä»»åŠ¡æ¨¡å‹ä¸çŠ¶æ€ä½“ç³»

**å®Œæˆæ—¶é—´**: 2026-01-13  
**å¼€å‘é˜¶æ®µ**: Step 2 - ä»»åŠ¡æ¨¡å‹ä¸çŠ¶æ€ä½“ç³»  
**å‚è€ƒæ–‡æ¡£**: `docs/04_tasks/roadmap.md`

---

## ç›®æ ‡å›é¡¾

- âœ… å»ºç«‹ task æ•°æ®è¡¨ä¸çŠ¶æ€æšä¸¾ï¼ˆStep 1 å·²å®Œæˆï¼‰
- âœ… æ”¯æŒåˆ›å»º/æŸ¥è¯¢/æ›´æ–°

## éªŒæ”¶æ ‡å‡†

- âœ… å¯åˆ›å»º task
- âœ… çŠ¶æ€å¯æ›´æ–°ä¸æŸ¥è¯¢

---

## å®Œæˆå†…å®¹

### 1. Pydantic Schemasï¼ˆæ•°æ®éªŒè¯æ¨¡å‹ï¼‰

åˆ›å»ºäº†å®Œæ•´çš„è¯·æ±‚/å“åº”æ¨¡å‹ï¼š

```
backend/app/schemas/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ common.py           # é€šç”¨å“åº”æ¨¡å‹
â””â”€â”€ task.py             # ä»»åŠ¡ç›¸å…³æ¨¡å‹
```

**ä»»åŠ¡ç›¸å…³ Schema**ï¼š

- `TaskCreate`: åˆ›å»ºä»»åŠ¡è¯·æ±‚æ¨¡å‹
- `TaskUpdate`: æ›´æ–°ä»»åŠ¡è¯·æ±‚æ¨¡å‹
- `TaskResponse`: ä»»åŠ¡å“åº”æ¨¡å‹
- `TaskListResponse`: ä»»åŠ¡åˆ—è¡¨å“åº”æ¨¡å‹
- `ResponseModel[T]`: ç»Ÿä¸€å“åº”æ¨¡å‹ï¼ˆæ³›å‹ï¼‰

### 2. ä»»åŠ¡æœåŠ¡å±‚ï¼ˆtask_service.pyï¼‰

å®ç°äº†å®Œæ•´çš„ä»»åŠ¡ä¸šåŠ¡é€»è¾‘ï¼š

```python
class TaskService:
    - create_task()              # åˆ›å»ºä»»åŠ¡
    - get_task(task_id)          # è·å–å•ä¸ªä»»åŠ¡
    - get_tasks(skip, limit, status)  # è·å–ä»»åŠ¡åˆ—è¡¨ï¼ˆåˆ†é¡µ+è¿‡æ»¤ï¼‰
    - update_task(task_id, update_data)  # æ›´æ–°ä»»åŠ¡
    - update_task_status(task_id, status, error_message)  # æ›´æ–°çŠ¶æ€
    - delete_task(task_id)       # åˆ é™¤ä»»åŠ¡
```

**ç‰¹æ€§**ï¼š
- æ”¯æŒåˆ†é¡µæŸ¥è¯¢
- æ”¯æŒæŒ‰çŠ¶æ€è¿‡æ»¤
- æ”¯æŒéƒ¨åˆ†å­—æ®µæ›´æ–°ï¼ˆPATCHï¼‰
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

### 3. API è·¯ç”±ï¼ˆtask.pyï¼‰

å®ç°äº† RESTful API æ¥å£ï¼š

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|------|
| POST | `/api/v1/tasks/` | åˆ›å»ºä»»åŠ¡ | è‡ªåŠ¨ç”Ÿæˆ UUID å’Œåˆå§‹çŠ¶æ€ |
| GET | `/api/v1/tasks/{task_id}` | è·å–ä»»åŠ¡è¯¦æƒ… | æ ¹æ® UUID æŸ¥è¯¢ |
| GET | `/api/v1/tasks/` | è·å–ä»»åŠ¡åˆ—è¡¨ | æ”¯æŒåˆ†é¡µå’ŒçŠ¶æ€è¿‡æ»¤ |
| PATCH | `/api/v1/tasks/{task_id}` | æ›´æ–°ä»»åŠ¡ | æ”¯æŒéƒ¨åˆ†å­—æ®µæ›´æ–° |
| PATCH | `/api/v1/tasks/{task_id}/status` | æ›´æ–°ä»»åŠ¡çŠ¶æ€ | ä¾¿æ·çš„çŠ¶æ€æ›´æ–°æ¥å£ |
| DELETE | `/api/v1/tasks/{task_id}` | åˆ é™¤ä»»åŠ¡ | ç‰©ç†åˆ é™¤ |

**API ç‰¹æ€§**ï¼š
- ç»Ÿä¸€çš„å“åº”æ ¼å¼ï¼ˆsuccess, message, dataï¼‰
- å®Œå–„çš„é”™è¯¯å¤„ç†ï¼ˆ404, 422 ç­‰ï¼‰
- è‡ªåŠ¨ç”Ÿæˆçš„ API æ–‡æ¡£ï¼ˆSwagger UIï¼‰
- ç±»å‹å®‰å…¨ï¼ˆPydantic éªŒè¯ï¼‰

### 4. è·¯ç”±æ³¨å†Œ

åœ¨ `main.py` ä¸­æ³¨å†Œäº† API è·¯ç”±ï¼š

```python
app.include_router(task_router.router, prefix="/api/v1")
```

è®¿é—®åœ°å€ï¼š
- API æ ¹è·¯å¾„: `http://localhost:8000/api/v1/tasks/`
- API æ–‡æ¡£: `http://localhost:8000/docs`

---

## éªŒæ”¶æµ‹è¯•ç»“æœ

### æµ‹è¯• 1ï¼šåˆ›å»ºä»»åŠ¡ âœ…

**å‘½ä»¤**ï¼š
```bash
curl -X POST http://localhost:8000/api/v1/tasks/
```

**ç»“æœ**ï¼šæˆåŠŸ

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
    "success": true,
    "message": "ä»»åŠ¡åˆ›å»ºæˆåŠŸ",
    "data": {
        "task_id": "48673fe0-5915-4b88-8631-e3b795607181",
        "image_path": null,
        "ocr_json_path": null,
        "excel_path": null,
        "ocr_job_id": null,
        "status": "uploaded",
        "error_message": null,
        "created_at": "2026-01-13T17:40:50.702090+08:00",
        "updated_at": "2026-01-13T17:40:50.702121+08:00"
    }
}
```

**éªŒè¯ç‚¹**ï¼š
- âœ… è‡ªåŠ¨ç”Ÿæˆ UUID
- âœ… åˆå§‹çŠ¶æ€ä¸º `uploaded`
- âœ… æ—¶é—´æˆ³è‡ªåŠ¨è®°å½•

### æµ‹è¯• 2ï¼šæŸ¥è¯¢å•ä¸ªä»»åŠ¡ âœ…

**å‘½ä»¤**ï¼š
```bash
curl http://localhost:8000/api/v1/tasks/48673fe0-5915-4b88-8631-e3b795607181
```

**ç»“æœ**ï¼šæˆåŠŸ

**éªŒè¯ç‚¹**ï¼š
- âœ… æ ¹æ® task_id å‡†ç¡®æŸ¥è¯¢
- âœ… è¿”å›å®Œæ•´ä»»åŠ¡ä¿¡æ¯
- âœ… ä¸å­˜åœ¨çš„ task_id è¿”å› 404

### æµ‹è¯• 3ï¼šæŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨ âœ…

**å‘½ä»¤**ï¼š
```bash
curl http://localhost:8000/api/v1/tasks/
```

**ç»“æœ**ï¼šæˆåŠŸ

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
    "success": true,
    "message": "è·å–ä»»åŠ¡åˆ—è¡¨æˆåŠŸ",
    "data": {
        "total": 3,
        "tasks": [...]
    }
}
```

**éªŒè¯ç‚¹**ï¼š
- âœ… è¿”å›æ€»æ•°å’Œä»»åŠ¡åˆ—è¡¨
- âœ… æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
- âœ… æ”¯æŒåˆ†é¡µï¼ˆskip, limitï¼‰

### æµ‹è¯• 4ï¼šæŒ‰çŠ¶æ€è¿‡æ»¤ âœ…

**å‘½ä»¤**ï¼š
```bash
curl "http://localhost:8000/api/v1/tasks/?status=uploaded"
```

**ç»“æœ**ï¼šæˆåŠŸ

**å“åº”**ï¼š
```json
{
    "success": true,
    "message": "è·å–ä»»åŠ¡åˆ—è¡¨æˆåŠŸ",
    "data": {
        "total": 2,
        "tasks": [
            // åªè¿”å› status=uploaded çš„ä»»åŠ¡
        ]
    }
}
```

**éªŒè¯ç‚¹**ï¼š
- âœ… æ­£ç¡®è¿‡æ»¤æŒ‡å®šçŠ¶æ€çš„ä»»åŠ¡
- âœ… æ€»æ•°ç»Ÿè®¡å‡†ç¡®

### æµ‹è¯• 5ï¼šæ›´æ–°ä»»åŠ¡çŠ¶æ€ âœ…

**å‘½ä»¤**ï¼š
```bash
# æ›´æ–°ä¸º ocr_processing
curl -X PATCH "http://localhost:8000/api/v1/tasks/48673fe0-5915-4b88-8631-e3b795607181/status?status=ocr_processing"

# æ›´æ–°ä¸º ocr_done
curl -X PATCH "http://localhost:8000/api/v1/tasks/48673fe0-5915-4b88-8631-e3b795607181/status?status=ocr_done"
```

**ç»“æœ**ï¼šæˆåŠŸ

**éªŒè¯ç‚¹**ï¼š
- âœ… çŠ¶æ€æˆåŠŸæ›´æ–°ï¼šuploaded -> ocr_processing -> ocr_done
- âœ… updated_at æ—¶é—´æˆ³è‡ªåŠ¨æ›´æ–°
- âœ… æ”¯æŒæ‰€æœ‰çŠ¶æ€æšä¸¾å€¼

### æµ‹è¯• 6ï¼šæ›´æ–°ä»»åŠ¡å®Œæ•´ä¿¡æ¯ âœ…

**å‘½ä»¤**ï¼š
```bash
curl -X PATCH http://localhost:8000/api/v1/tasks/48673fe0-5915-4b88-8631-e3b795607181 \
  -H "Content-Type: application/json" \
  -d '{"ocr_job_id": "test-job-123", "status": "excel_generated"}'
```

**ç»“æœ**ï¼šæˆåŠŸ

**å“åº”**ï¼š
```json
{
    "success": true,
    "message": "ä»»åŠ¡æ›´æ–°æˆåŠŸ",
    "data": {
        "task_id": "48673fe0-5915-4b88-8631-e3b795607181",
        "ocr_job_id": "test-job-123",
        "status": "excel_generated",
        ...
    }
}
```

**éªŒè¯ç‚¹**ï¼š
- âœ… æ”¯æŒå¤šå­—æ®µåŒæ—¶æ›´æ–°
- âœ… åªæ›´æ–°æä¾›çš„å­—æ®µï¼ˆéƒ¨åˆ†æ›´æ–°ï¼‰
- âœ… æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“

### æµ‹è¯• 7ï¼šæ•°æ®åº“éªŒè¯ âœ…

**å‘½ä»¤**ï¼š
```bash
sqlite3 data/ocr_pngtoexcel.db "SELECT task_id, status, ocr_job_id FROM tasks ORDER BY created_at;"
```

**ç»“æœ**ï¼š
```
48673fe0-5915-4b88-8631-e3b795607181|excel_generated|test-job-123
c545b534-aeef-4eed-9a8d-d907a5950f1b|uploaded|
7768a528-0169-49e6-b02f-869a08c2bb01|uploaded|
```

**éªŒè¯ç‚¹**ï¼š
- âœ… æ•°æ®æ­£ç¡®å†™å…¥æ•°æ®åº“
- âœ… çŠ¶æ€å’Œå…³è”å­—æ®µæ­£ç¡®å­˜å‚¨
- âœ… 3ä¸ªä»»åŠ¡éƒ½å­˜åœ¨

---

## API æ–‡æ¡£éªŒè¯

è®¿é—® http://localhost:8000/docs å¯ä»¥çœ‹åˆ°ï¼š

âœ… **è‡ªåŠ¨ç”Ÿæˆçš„ Swagger UI æ–‡æ¡£**
- æ‰€æœ‰æ¥å£éƒ½å·²æ³¨å†Œ
- è¯·æ±‚/å“åº”æ¨¡å‹éƒ½æœ‰å®Œæ•´çš„æè¿°
- æ”¯æŒåœ¨çº¿æµ‹è¯•

âœ… **æ¥å£åˆ†ç»„**
- æ ‡ç­¾ï¼šä»»åŠ¡ç®¡ç†
- æ¸…æ™°çš„æ¥å£è¯´æ˜å’Œå‚æ•°æè¿°

âœ… **æ•°æ®æ¨¡å‹ Schema**
- TaskCreate, TaskUpdate, TaskResponse ç­‰æ¨¡å‹å®Œæ•´å±•ç¤º
- å­—æ®µç±»å‹ã€æ˜¯å¦å¿…å¡«ã€é»˜è®¤å€¼ç­‰ä¿¡æ¯æ¸…æ™°

---

## æŠ€æœ¯äº®ç‚¹

### 1. åˆ†å±‚æ¶æ„

```
Controller (API Router) 
    â†“
Service (Business Logic)
    â†“
Model (Database)
```

- **èŒè´£æ¸…æ™°**ï¼šè·¯ç”±åªè´Ÿè´£å‚æ•°éªŒè¯å’Œå“åº”æ ¼å¼ï¼Œä¸šåŠ¡é€»è¾‘åœ¨æœåŠ¡å±‚
- **æ˜“äºæµ‹è¯•**ï¼šæœåŠ¡å±‚å¯ç‹¬ç«‹æµ‹è¯•
- **ä¾¿äºæ‰©å±•**ï¼šæ–°å¢åŠŸèƒ½åªéœ€åœ¨å¯¹åº”å±‚æ·»åŠ 

### 2. ç»Ÿä¸€å“åº”æ ¼å¼

```python
ResponseModel[T] {
    success: bool
    message: str
    data: T | None
}
```

**ä¼˜åŠ¿**ï¼š
- å‰ç«¯ç»Ÿä¸€è§£æ
- é”™è¯¯ä¿¡æ¯æ¸…æ™°
- ç±»å‹å®‰å…¨ï¼ˆæ³›å‹ï¼‰

### 3. éƒ¨åˆ†æ›´æ–°æ”¯æŒ

ä½¿ç”¨ `model_dump(exclude_unset=True)` å®ç°ï¼š
- åªæ›´æ–°å®¢æˆ·ç«¯æä¾›çš„å­—æ®µ
- é¿å…è¦†ç›–å…¶ä»–å­—æ®µ
- ç¬¦åˆ RESTful PATCH è¯­ä¹‰

### 4. ç±»å‹å®‰å…¨

- æ‰€æœ‰å‚æ•°å’Œè¿”å›å€¼éƒ½æœ‰ç±»å‹æ ‡æ³¨
- Pydantic è‡ªåŠ¨éªŒè¯
- UUID ç±»å‹ä¿è¯ ID æ ¼å¼æ­£ç¡®

### 5. é”™è¯¯å¤„ç†

- ä»»åŠ¡ä¸å­˜åœ¨ï¼šè¿”å› 404
- å‚æ•°é”™è¯¯ï¼šè‡ªåŠ¨è¿”å› 422
- ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†

---

## æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶

```
backend/app/
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ __init__.py          # Schema æ¨¡å—å¯¼å‡º
â”‚   â”œâ”€â”€ common.py            # é€šç”¨å“åº”æ¨¡å‹
â”‚   â””â”€â”€ task.py              # ä»»åŠ¡ç›¸å…³ Schema
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ __init__.py          # æœåŠ¡å±‚æ¨¡å—
â”‚   â””â”€â”€ task_service.py      # ä»»åŠ¡æœåŠ¡
â””â”€â”€ api/
    â”œâ”€â”€ __init__.py
    â””â”€â”€ v1/
        â”œâ”€â”€ __init__.py
        â””â”€â”€ task.py          # ä»»åŠ¡ API è·¯ç”±
```

### ä¿®æ”¹æ–‡ä»¶

```
backend/app/main.py
- å¯¼å…¥ä»»åŠ¡è·¯ç”±
- æ³¨å†Œ API è·¯ç”±ï¼ˆ/api/v1ï¼‰
```

---

## éªŒæ”¶ç»“è®º

âœ… **Step 2 éªŒæ”¶é€šè¿‡**

æ‰€æœ‰ç›®æ ‡å’ŒéªŒæ”¶æ ‡å‡†å‡å·²è¾¾æˆï¼š

1. âœ… **å¯åˆ›å»º task**
   - POST /api/v1/tasks/ æ­£å¸¸å·¥ä½œ
   - è‡ªåŠ¨ç”Ÿæˆ UUID å’Œåˆå§‹çŠ¶æ€
   - æ•°æ®æ­£ç¡®å†™å…¥æ•°æ®åº“

2. âœ… **çŠ¶æ€å¯æ›´æ–°ä¸æŸ¥è¯¢**
   - GET /api/v1/tasks/{task_id} å¯æŸ¥è¯¢å•ä¸ªä»»åŠ¡
   - GET /api/v1/tasks/ å¯æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨
   - PATCH /api/v1/tasks/{task_id}/status å¯æ›´æ–°çŠ¶æ€
   - PATCH /api/v1/tasks/{task_id} å¯æ›´æ–°å®Œæ•´ä¿¡æ¯
   - æ”¯æŒæŒ‰çŠ¶æ€è¿‡æ»¤æŸ¥è¯¢

**é¢å¤–å®Œæˆ**ï¼š
- å®Œæ•´çš„ CRUD æ¥å£ï¼ˆåŒ…æ‹¬åˆ é™¤ï¼‰
- åˆ†é¡µå’Œè¿‡æ»¤åŠŸèƒ½
- ç»Ÿä¸€çš„å“åº”æ ¼å¼
- è‡ªåŠ¨ç”Ÿæˆçš„ API æ–‡æ¡£
- æœåŠ¡å±‚ä¸šåŠ¡é€»è¾‘å°è£…
- ç±»å‹å®‰å…¨å’Œæ•°æ®éªŒè¯

**å·¥ç¨‹è´¨é‡**ï¼š
- ä»£ç ç»“æ„æ¸…æ™°ï¼Œåˆ†å±‚åˆç†
- å®Œå–„çš„é”™è¯¯å¤„ç†
- ç¬¦åˆ RESTful è§„èŒƒ
- æ˜“äºæµ‹è¯•å’Œæ‰©å±•

---

## å¿«é€Ÿæµ‹è¯•å‘½ä»¤

```bash
# 1. åˆ›å»ºä»»åŠ¡
curl -X POST http://localhost:8000/api/v1/tasks/

# 2. æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨
curl http://localhost:8000/api/v1/tasks/

# 3. æŸ¥è¯¢å•ä¸ªä»»åŠ¡ï¼ˆæ›¿æ¢ task_idï¼‰
curl http://localhost:8000/api/v1/tasks/{task_id}

# 4. æ›´æ–°ä»»åŠ¡çŠ¶æ€
curl -X PATCH "http://localhost:8000/api/v1/tasks/{task_id}/status?status=ocr_processing"

# 5. æ›´æ–°ä»»åŠ¡ä¿¡æ¯
curl -X PATCH http://localhost:8000/api/v1/tasks/{task_id} \
  -H "Content-Type: application/json" \
  -d '{"ocr_job_id": "job-123", "status": "ocr_done"}'

# 6. æŸ¥çœ‹ API æ–‡æ¡£
æµè§ˆå™¨è®¿é—®: http://localhost:8000/docs
```

---

## ä¸‹ä¸€æ­¥ï¼šStep 3

**ç›®æ ‡**ï¼šå›¾ç‰‡ä¸Šä¼ ä¸æœ¬åœ°å­˜å‚¨

- å®ç°å›¾ç‰‡ä¸Šä¼ æ¥å£
- å›¾ç‰‡è½ç›˜åˆ° data/images/
- ä¸ä»»åŠ¡ç»‘å®šï¼ˆæ›´æ–° image_pathï¼‰
- çŠ¶æ€æ›´æ–°ä¸º uploaded

è¯¦è§ï¼š`docs/04_tasks/roadmap.md`

---

**å¯ç»§ç»­ä¸‹ä¸€æ­¥å¼€å‘ï¼** ğŸ‰

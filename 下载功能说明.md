# 下载 Excel 功能说明

## 问题分析

用户反馈：点击"下载 Excel"时显示"正在生成Excel文件"，然后失败显示"保存表格数据失败: Bad Request"。

### 错误原因

之前的代码逻辑：
```typescript
// 错误的流程
1. 尝试下载
2. 如果失败 → 调用 saveTableData（保存编辑数据）❌
3. 调用 generateExcel
4. 重新下载
```

**问题**：
- `saveTableData` 是用于保存**编辑后的数据**，生成基于编辑的 Excel
- 首次下载时，用户可能没有编辑，直接调用 `saveTableData` 会失败
- 应该直接调用 `generateExcel`，它会从 OCR JSON 生成 Excel

## 正确的流程

### Step 6 已完成的功能

根据 `docs/06_dev_logs/step6_completion_report.md`：
- ✅ 已实现 `POST /api/v1/excel/generate/{task_id}` 接口
- ✅ 该接口从 OCR JSON 生成 Excel 文件
- ✅ 不需要先保存编辑数据

### 修复后的下载流程

```typescript
1. 用户点击"下载 Excel"
2. 如果有未保存的修改 → 询问是否先保存
3. 尝试下载
4. 如果下载失败（Excel 不存在）：
   ↓
   只调用 generateExcel(taskId)  ← 关键修改
   （从 OCR JSON 生成 Excel）
   ↓
5. 重新下载
```

## 代码修改

### 修改 1: 下载逻辑优化

```typescript
// 修改前
await saveTableData(taskId, tableData);  // ❌ 错误
await generateExcel(taskId);

// 修改后
await generateExcel(taskId);  // ✅ 正确
// generateExcel 会从 OCR JSON 生成 Excel
```

### 修改 2: 移除自动生成

移除了表格加载时的自动生成逻辑，改为按需生成（点击下载时）。

## 使用场景

### 场景 1: 首次下载（无编辑）
```
1. OCR 识别完成
2. 查看表格（无编辑）
3. 点击"下载 Excel"
   → generateExcel 从 OCR JSON 生成
   → 下载成功 ✅
```

### 场景 2: 编辑后下载
```
1. OCR 识别完成
2. 查看并编辑表格
3. 点击"下载 Excel"
   → 询问是否保存
   → 如果选择保存：saveTableData + generateExcel
   → 如果选择不保存：直接 generateExcel（原始数据）
   → 下载成功 ✅
```

### 场景 3: 保存后下载
```
1. OCR 识别完成
2. 编辑表格
3. 点击"保存修改"
   → saveTableData + generateExcel（已完成）
4. 点击"下载 Excel"
   → 直接下载 ✅
```

## API 接口说明

### generateExcel

**接口**: `POST /api/v1/excel/generate/{task_id}`

**功能**: 从 OCR JSON 生成 Excel 文件

**前置条件**:
- OCR JSON 文件存在
- 任务状态为 `ocr_done` 或 `excel_generated`

**不需要**:
- ❌ 不需要先保存编辑数据
- ❌ 不需要提供表格数据

### saveTableData

**接口**: `POST /api/v1/table/save/{task_id}`

**功能**: 保存编辑后的表格数据，并重新生成 Excel

**前置条件**:
- 需要提供完整的表格数据（TableDataResponse）

**使用场景**:
- ✅ 用户编辑了表格，需要保存修改

## 验证步骤

1. 访问: http://10.119.133.236:3000
2. 上传图片并等待 OCR 完成
3. 直接点击"下载 Excel"（不编辑）
4. 应该成功下载 ✅

5. 编辑某个单元格
6. 点击"下载 Excel"
7. 选择"取消"（不保存修改）
8. 应该下载原始数据的 Excel ✅

9. 再次编辑
10. 点击"下载 Excel"
11. 选择"确定"（保存修改）
12. 应该下载包含修改的 Excel ✅

